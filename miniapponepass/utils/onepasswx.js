!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){var n,o,i="0123456789abcdefghijklmnopqrstuvwxyz".split(""),r=[];if(t=t||i.length,e)for(n=0;n<e;n++)r[n]=i[0|Math.random()*t];else for(r[8]=r[13]=r[18]=r[23],r[14]="4",n=0;n<36;n++)r[n]||(o=0|16*Math.random(),r[n]=i[19==n?3&o|8:o]);return r.join("")}var t,n=function(e,t){function n(e){return function(e){for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,o=-271733879,u=-1732584194,p=271733878,d=0;d<e.length;d+=16){var f=n,m=o,l=u,h=p;n=i(n,o,u,p,e[d+0],7,-680876936),p=i(p,n,o,u,e[d+1],12,-389564586),u=i(u,p,n,o,e[d+2],17,606105819),o=i(o,u,p,n,e[d+3],22,-1044525330),n=i(n,o,u,p,e[d+4],7,-176418897),p=i(p,n,o,u,e[d+5],12,1200080426),u=i(u,p,n,o,e[d+6],17,-1473231341),o=i(o,u,p,n,e[d+7],22,-45705983),n=i(n,o,u,p,e[d+8],7,1770035416),p=i(p,n,o,u,e[d+9],12,-1958414417),u=i(u,p,n,o,e[d+10],17,-42063),o=i(o,u,p,n,e[d+11],22,-1990404162),n=i(n,o,u,p,e[d+12],7,1804603682),p=i(p,n,o,u,e[d+13],12,-40341101),u=i(u,p,n,o,e[d+14],17,-1502002290),o=i(o,u,p,n,e[d+15],22,1236535329),n=r(n,o,u,p,e[d+1],5,-165796510),p=r(p,n,o,u,e[d+6],9,-1069501632),u=r(u,p,n,o,e[d+11],14,643717713),o=r(o,u,p,n,e[d+0],20,-373897302),n=r(n,o,u,p,e[d+5],5,-701558691),p=r(p,n,o,u,e[d+10],9,38016083),u=r(u,p,n,o,e[d+15],14,-660478335),o=r(o,u,p,n,e[d+4],20,-405537848),n=r(n,o,u,p,e[d+9],5,568446438),p=r(p,n,o,u,e[d+14],9,-1019803690),u=r(u,p,n,o,e[d+3],14,-187363961),o=r(o,u,p,n,e[d+8],20,1163531501),n=r(n,o,u,p,e[d+13],5,-1444681467),p=r(p,n,o,u,e[d+2],9,-51403784),u=r(u,p,n,o,e[d+7],14,1735328473),o=r(o,u,p,n,e[d+12],20,-1926607734),n=a(n,o,u,p,e[d+5],4,-378558),p=a(p,n,o,u,e[d+8],11,-2022574463),u=a(u,p,n,o,e[d+11],16,1839030562),o=a(o,u,p,n,e[d+14],23,-35309556),n=a(n,o,u,p,e[d+1],4,-1530992060),p=a(p,n,o,u,e[d+4],11,1272893353),u=a(u,p,n,o,e[d+7],16,-155497632),o=a(o,u,p,n,e[d+10],23,-1094730640),n=a(n,o,u,p,e[d+13],4,681279174),p=a(p,n,o,u,e[d+0],11,-358537222),u=a(u,p,n,o,e[d+3],16,-722521979),o=a(o,u,p,n,e[d+6],23,76029189),n=a(n,o,u,p,e[d+9],4,-640364487),p=a(p,n,o,u,e[d+12],11,-421815835),u=a(u,p,n,o,e[d+15],16,530742520),o=a(o,u,p,n,e[d+2],23,-995338651),n=s(n,o,u,p,e[d+0],6,-198630844),p=s(p,n,o,u,e[d+7],10,1126891415),u=s(u,p,n,o,e[d+14],15,-1416354905),o=s(o,u,p,n,e[d+5],21,-57434055),n=s(n,o,u,p,e[d+12],6,1700485571),p=s(p,n,o,u,e[d+3],10,-1894986606),u=s(u,p,n,o,e[d+10],15,-1051523),o=s(o,u,p,n,e[d+1],21,-2054922799),n=s(n,o,u,p,e[d+8],6,1873313359),p=s(p,n,o,u,e[d+15],10,-30611744),u=s(u,p,n,o,e[d+6],15,-1560198380),o=s(o,u,p,n,e[d+13],21,1309151649),n=s(n,o,u,p,e[d+4],6,-145523070),p=s(p,n,o,u,e[d+11],10,-1120210379),u=s(u,p,n,o,e[d+2],15,718787259),o=s(o,u,p,n,e[d+9],21,-343485551),n=c(n,f),o=c(o,m),u=c(u,l),p=c(p,h)}return Array(n,o,u,p)}(function(e){for(var t=Array(),n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length))}function o(e,t,n,o,i,r){return c((a=c(c(t,e),c(o,r)))<<(s=i)|a>>>32-s,n);var a,s}function i(e,t,n,i,r,a,s){return o(t&n|~t&i,e,t,r,a,s)}function r(e,t,n,i,r,a,s){return o(t&i|n&~i,e,t,r,a,s)}function a(e,t,n,i,r,a,s){return o(t^n^i,e,t,r,a,s)}function s(e,t,n,i,r,a,s){return o(n^(t|~i),e,t,r,a,s)}function c(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function u(e,t){var n,o,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=[];if(t=t||i.length,e)for(n=0;n<e;n++)r[n]=i[0|Math.random()*t];else for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",n=0;n<36;n++)r[n]||(o=0|16*Math.random(),r[n]=i[19==n?3&o|8:o]);return r.join("")}let p={uuid:"",msgId:"",timestamp:"",version:"1.2",userInformation:encodeURIComponent(function(e){var t,n,o,i,r,a,s,c="",u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",p=0;for(e=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t}(e);p<e.length;)t=e.charCodeAt(p++),n=e.charCodeAt(p++),o=e.charCodeAt(p++),i=t>>2,r=(3&t)<<4|n>>4,a=(15&n)<<2|o>>6,s=63&o,isNaN(n)?a=s=64:isNaN(o)&&(s=64),c=c+u.charAt(i)+u.charAt(r)+u.charAt(a)+u.charAt(s);return c}(function(){try{const t=wx.getSystemInfoSync();var e=t.brand+"@@"+t.model+"@@"+t.pixelRatio+"@@"+t.screenWidth+"@@"+t.screenHeight+"@@"+t.language+"@@"+t.version+"@@"+t.system+"@@"+t.platform+"@@"+t.SDKVersion+"@@"+t.benchmarkLevel+"@@"+(new Date).getTimezoneOffset();return encodeURIComponent(t.brand+"@@"+t.version+"@@"+t.system+"@@"+n(e))}catch(t){}}()))},d="http://120.197.235.102:7002/NumberAbility/h5/getMobile.htm?",f="http://www.cmpassport.com/NumberAbility/h5/getMobile.htm?",m="http://120.197.235.102:7002/NumberAbility/h5/getToken.htm",l="https://www.cmpassport.com/NumberAbility/h5/getToken.htm";return{getSign:function(e){return p.msgId=u(32,32),p.uuid=u(32,32),p.timestamp=function(e,t){var n={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),"S+":e.getMilliseconds()};for(var o in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),n)new RegExp("("+o+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?n[o]:((3==RegExp.$1.length&&"S+"==o?"000":"00")+n[o]).substr((""+n[o]).length)));return t}(new Date,"yyyyMMddhhmmssSSS"),e+p.msgId+p.timestamp+p.uuid+p.version},getImgSrc:function(e){const t=wx.getAccountInfoSync();let n=""===e.expandParams?"callType=6005":"callType=6005|"+e.expandParams;return("0"===e.isTest?d:f)+"version="+p.version+"&appId="+e.appId+"&openType="+e.openType+"&expandParams="+encodeURIComponent(n)+"&msgId="+p.msgId+"&timestamp="+p.timestamp+"&uuid="+p.uuid+"&userInformation="+p.userInformation+"&wxappid="+t.miniProgram.appId},getTokenInfo:function(e){const t=wx.getAccountInfoSync();var n=""===e.data.expandParams?"callType=6006":"callType=6006|"+e.data.expandParams;let o={version:p.version,appId:e.data.appId,openType:e.data.openType,expandParams:n,isTest:e.data.isTest,sign:e.data.sign,uuid:p.uuid,msgId:p.msgId,timestamp:p.timestamp,userInformation:p.userInformation,wxappid:t.miniProgram.appId,timeout:e.data.timeout||3e3},i={header:{version:o.version,msgId:o.msgId,timestamp:o.timestamp,appId:o.appId},body:{expandParams:o.expandParams,sign:o.sign,uuid:o.uuid,wxappid:o.wxappid}},r="0"===o.isTest?m:l;wx.request({url:r,data:JSON.stringify(i),method:"post",header:{"content-type":"application/json"},timeout:o.timeout,success(t){if(""!=t.data.body.token){var n={code:t.data.header.resultCode,token:t.data.body.token,userInformation:o.userInformation,message:"获取token成功"};e.success({code:n.code,message:n.message,token:n.token,userInformation:n.userInformation,msgId:o.msgId})}else{n={code:t.data.header.resultCode,message:t.data.body.resultDesc};e.error({code:n.code,message:n.message,msgId:o.msgId})}},fail(t){var n="500",i="接口异常||超时，获取token失败";e.error({code:n,message:i,msgId:o.msgId})}})}}}(),o=(t={precheckUrl:{test:"https://opencloud.wostore.cn/openapi-test/netauth/precheck/u3",pro:"https://opencloud.wostore.cn/openapi/netauth/precheck/u3"},optparams:{uuid:"",timestamp:Date.now(),version:"v4.0",clientType:"2",format:"jsonp",clientId:"",timeout:5e3,result:""}},{getSign:function(e){return t.optparams.timestamp=Date.now(),"cuCallback"+e+t.optparams.clientType+t.optparams.format+t.optparams.timestamp+t.optparams.version},getAuthCode:function(e){if("[object Function]"!==Object.prototype.toString.call(e.result))throw{error:"arguments invalid"};t.optparams.clientId=e.clientId,t.optparams.timeout=e.timeout,t.optparams.result=e.result,t.optparams.uuid=function(e,t){var n,o,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=[];if(t=t||i.length,e)for(n=0;n<e;n++)r[n]=i[0|Math.random()*t];else for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",n=0;n<36;n++)r[n]||(o=0|16*Math.random(),r[n]=i[19==n?3&o|8:o]);return r.join("")}(32,32),function(e){var n=t.optparams.timeout,o={callback:"cuCallback",timestamp:t.optparams.timestamp,client_id:t.optparams.clientId,client_type:t.optparams.clientType,version:t.optparams.version,format:t.optparams.format,sign:e},i=[],r=o;for(var a in r)i.push(encodeURIComponent(a)+"="+encodeURIComponent(r[a]));wx.request({method:"get",url:t.precheckUrl.pro+"?"+i.join("&"),header:{"content-type":"application/x-www-form-urlencoded"},timeout:n,success(e){var n=function(e){var t=e;if(-1!==e.indexOf("cuCallback")){var n=e.indexOf("("),o=e.indexOf(")"),i=e.substring(n+1,o);t=JSON.parse(i)}return t}(e.data),o={code:n.code,msg:n.msg};0==n.code?(o.accesscode=n.data.accessCode,o.operatorType=n.data.operatorType):o.msgId=n.data,t.optparams.result(o)},fail(e){t.optparams.result({code:"408",msg:"联通请求失败||超时"})}})}(e.sign)}}),i=!0;function r(e){this.gtapi_domain="onepass.geetest.com",Object.assign(this,e),this.phone=0,this.process_id="",this.accesscode="",this.cm_data={},this.pre_init=e.pre_init===undefined||e.pre_init,this.presign=n.getSign(""),this.presign_cu=o.getSign("{client_id}"),this.OnepassConfig={haspreASK:!1,presign:this.presign,presign_cu:this.presign_cu,data:{},ip:!1},this.pre_init&&this.preGate()}r.prototype={constructor:r,gateway:function(t,r){var a=this;if(this.phone=t,i){i=!1;var s=a.OnepassConfig.haspreASK&&a.OnepassConfig.data.data&&!a.OnepassConfig.ip&&!a.phone;if(a.OnepassConfig.haspreASK&&a.OnepassConfig.data.data&&a.OnepassConfig.ip||s)a.getPreAccess(a.OnepassConfig.data,r);else{var c=n.getSign(""),u=o.getSign("{client_id}");wx.request({url:"https://onepass.geetest.com/web/pre_gateway",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:{app_id:this.app_id,sdk:"wx.2.1.1",phone:this.phone,clienttype:2,presign:c,presign_cu:u},timeout:a.timeout||3e3,success:function(e){var t=e.data;t&&200===t.status?a.getPreAccess(t,r):(i=!0,r&&r({code:101}),a.clientLog(e,"101"))},fail:function(t){i=!0,r&&r({code:100});var n=e();a.clientLog({msg:t||"pre_gateway请求失败||超时",process_id:n},"100")}})}}},getTokenMobile:function(e,t,n){var o=this;wx.request({url:e,data:t,dataType:"json",method:"POST",timeout:o.timeout||3e3,header:{"content-type":"application/x-www-form-urlencoded",accept:"application/json"},success:function(e){200!==e.statusCode||1e4!==e.data.result&&0!==e.data.result?(i=!0,n&&n({code:103}),o.clientLog(e&&e.data,"103")):(o.accesscode=e.data.data,n&&n(null,"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),o.clientLog(e&&e.data,"0"))},fail:function(){i=!0,n&&n({code:102}),o.clientLog({process_id:o.process_id,msg:"电信接口请求失败||超时"},"102")}})},getCUToken:function(e,t){var n=this;o.getAuthCode({clientId:e.client_id,sign:e.sign,timeout:n.timeout||3e3,result:function(e){"0"==e.code?(n.accesscode=e.accesscode,t&&t(null,"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),n.clientLog(e,"0")):(i=!0,t&&t({code:"107",msg:"联通取号失败"}),n.clientLog(e,"107"))}})},getTokenStatus:function(e){var t=this;t.cm_data&&t.cm_data.sign&&1===t.cm_data.operator?n.getTokenInfo({data:{appId:t.cm_data.appid,sign:t.cm_data.sign,openType:"1",timeout:t.timeout||3e3},success:function(n){i=!0,e&&e(null,{process_id:t.process_id,accesscode:n.token+"||"+n.userInformation}),t.clientLog(n,"0")},error:function(n){i=!0,e&&e({code:104}),t.clientLog({msg:n||"移动取号失败"},"104")}}):t.accesscode?(i=!0,e&&e(null,{process_id:t.process_id,accesscode:t.accesscode})):(i=!0,e&&e({code:105}))},clientLog:function(e,t){var n=t||"undefined",o=this.process_id||e&&e.process_id;e&&"object"==typeof e&&(e=JSON.stringify(e)),wx.request({method:"POST",url:"https://onepass.geetest.com/web/client_report",timeout:this.timeout,header:{"content-type":"application/x-www-form-urlencoded"},data:{process_id:o,code:n,metadata:e,type:"wx"}})},preGate:function(){var t=this;wx.request({url:"https://onepass.geetest.com/web/pre_gateway",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:{app_id:this.app_id,sdk:"wx.2.1.1",phone:this.phone,clienttype:2,presign:t.OnepassConfig.presign,presign_cu:t.OnepassConfig.presign_cu},timeout:t.timeout||3e3,success:function(e){t.OnepassConfig.haspreASK=!0;var n=e.data;n&&200===n.status?(t.OnepassConfig.data=n,t.OnepassConfig.ip=n.data&&1===n.data.operator_rule||!1):(i=!0,t.OnepassConfig.haspreASK=!0,t.OnepassConfig.ip=!1,t.clientLog(e,"101"))},fail:function(n){i=!0;var o=e();t.OnepassConfig.haspreASK=!1,t.clientLog({process_id:o,msg:n||"请求pregateway出错"},"100")}})},getPreAccess:function(e,t){if(this.process_id=e.process_id,this.OnepassConfig.haspreASK=!1,this.cm_data.operator=e.data.operator,this.accesscode="",e.data&&1===e.data.operator){var o={appId:e.data.option[1].appid,openType:"1"},i=e.data.option[1];this.cm_data.sign=i.sign,this.cm_data.appid=i.appid;var r=n.getImgSrc(o);t&&t(null,r)}else if(e.data&&3===e.data.operator){var a=e.data.option[3];this.getCUToken(a,t)}else{var s=e.data.option[2];this.getTokenMobile(e.data.url,s,t)}}},module.exports=r}));
